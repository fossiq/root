name: CI

on:
  push:
    branches:
      - main
    paths:
      - "packages/**"
      - "!packages/**/*.md"
      - ".github/workflows/**"
      - "!*.md"
      - "!.github/instructions/**"

permissions:
  id-token: write # Required for OIDC
  contents: write
  packages: write # Required for GitHub Packages

jobs:
  # Cross-platform binding build matrix
  build_bindings:
    name: Build Binding ${{ matrix.os }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: ubuntu-24.04-arm
            platform: linux
            arch: arm64
          - os: windows-latest
            platform: win32
            arch: x64
          - os: macos-latest
            platform: darwin
            arch: arm64

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.4

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Cache tree-sitter binding
        id: cache-binding
        uses: actions/cache@v4
        with:
          path: packages/kql-parser/prebuilds/${{ matrix.platform }}-${{ matrix.arch }}/tree-sitter-kql.node
          key: binding-${{ matrix.platform }}-${{ matrix.arch }}-${{ hashFiles('packages/kql-parser/src/**/*.c', 'packages/kql-parser/src/**/*.h', 'packages/kql-parser/src/**/*.json', 'packages/kql-parser/binding.gyp') }}

      - name: Build Binding
        if: steps.cache-binding.outputs.cache-hit != 'true'
        working-directory: packages/kql-parser
        run: bun scripts/build-binding.ts

      - name: Upload Binding Artifact
        uses: actions/upload-artifact@v4
        with:
          name: binding-${{ matrix.platform }}-${{ matrix.arch }}
          path: packages/kql-parser/prebuilds/${{ matrix.platform }}-${{ matrix.arch }}/tree-sitter-kql.node
          if-no-files-found: error

  # WASM build using WASI SDK (no Docker needed)
  build_wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.4

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Cache WASM build
        id: cache-wasm
        uses: actions/cache@v4
        with:
          path: packages/kql-parser/tree-sitter-kql.wasm
          key: wasm-${{ hashFiles('packages/kql-parser/src/**/*.c', 'packages/kql-parser/src/**/*.h', 'packages/kql-parser/src/**/*.json', 'packages/kql-parser/grammar.js') }}

      - name: Build WASM (uses WASI SDK, auto-downloads)
        if: steps.cache-wasm.outputs.cache-hit != 'true'
        working-directory: packages/kql-parser
        run: |
          bunx tree-sitter-cli@latest build --wasm
          echo "WASM built successfully"
          ls -la tree-sitter-kql.wasm

      - name: Upload WASM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm
          path: packages/kql-parser/tree-sitter-kql.wasm
          if-no-files-found: error

  build-test-publish:
    needs: [build_bindings, build_wasm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.4

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      # Download all binding artifacts
      - name: Download Cross-Platform Bindings
        uses: actions/download-artifact@v4
        with:
          path: packages/kql-parser/prebuilds
          pattern: binding-*
          merge-multiple: false

      - name: Organize Bindings
        run: |
          cd packages/kql-parser/prebuilds
          for dir in binding-*; do
            target="${dir#binding-}"
            mkdir -p "$target"
            mv "$dir"/* "$target/"
            rmdir "$dir"
          done
          echo "Organized prebuilds:"
          ls -R

      # Download WASM artifact
      - name: Download WASM
        uses: actions/download-artifact@v4
        with:
          name: wasm
          path: packages/kql-parser

      - name: Build all packages
        run: bun run build

      - name: Run tests
        run: bun run test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./packages/*/coverage/lcov.info
          fail_ci_if_error: false
          verbose: true

      - name: Check if version changed
        id: version-check
        run: |
          LOCAL_VERSION=$(jq -r '.version' packages/kql-parser/package.json)
          REMOTE_VERSION=$(npm view @fossiq/kql-parser version --registry=https://npm.pkg.github.com 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL_VERSION, remote=$REMOTE_VERSION"
          if [ "$LOCAL_VERSION" != "$REMOTE_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .npmrc for GitHub Packages
        if: steps.version-check.outputs.changed == 'true'
        run: |
          echo "@fossiq:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Publish packages
        if: steps.version-check.outputs.changed == 'true'
        run: bun run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger UI deployment
        run: gh workflow run deploy.yml --repo fossiq/fossiq.github.io
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        if: steps.version-check.outputs.changed == 'true'
        uses: changesets/action@v1
        with:
          publish: echo "Already published via turbo"
          commit: "chore: version packages"
          title: "Release packages"
          createGithubReleases: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: CI

on:
  push:
    branches:
      - main
    paths:
      - "packages/**"
      - "!packages/**/*.md"
      - ".github/workflows/**"
      - ".github/scripts/**"
      - "!*.md"
      - "!.github/instructions/**"

permissions:
  id-token: write # Required for OIDC
  contents: write
  packages: write # Required for GitHub Packages

jobs:
  # Cross-platform binding build matrix
  build_bindings:
    name: Build Binding ${{ matrix.os }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: ubuntu-24.04-arm
            platform: linux
            arch: arm64
          - os: windows-latest
            platform: win32
            arch: x64
          - os: macos-latest
            platform: darwin
            arch: arm64

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.4
          no-cache: true

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ matrix.arch }}-node-modules-${{ hashFiles('bun.lock') }}

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile

      - name: Cache tree-sitter binding
        id: cache-binding
        uses: actions/cache@v4
        with:
          path: packages/kql-parser/prebuilds/${{ matrix.platform }}-${{ matrix.arch }}/tree-sitter-kql.node
          key: binding-${{ matrix.platform }}-${{ matrix.arch }}-${{ hashFiles('packages/kql-parser/src/**/*.c', 'packages/kql-parser/src/**/*.h', 'packages/kql-parser/src/**/*.json', 'packages/kql-parser/binding.gyp') }}

      - name: Build Binding
        if: steps.cache-binding.outputs.cache-hit != 'true'
        working-directory: packages/kql-parser
        run: bun scripts/build-binding.ts

      - name: Upload Binding Artifact
        uses: actions/upload-artifact@v4
        with:
          name: binding-${{ matrix.platform }}-${{ matrix.arch }}
          path: packages/kql-parser/prebuilds/${{ matrix.platform }}-${{ matrix.arch }}/tree-sitter-kql.node
          if-no-files-found: error

  # WASM build using WASI SDK (no Docker needed)
  build_wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.4
          no-cache: true

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-x64-node-modules-${{ hashFiles('bun.lock') }}

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile

      - name: Cache WASM build
        id: cache-wasm
        uses: actions/cache@v4
        with:
          path: packages/kql-parser/tree-sitter-kql.wasm
          key: wasm-${{ hashFiles('packages/kql-parser/src/**/*.c', 'packages/kql-parser/src/**/*.h', 'packages/kql-parser/src/**/*.json', 'packages/kql-parser/grammar.js') }}

      - name: Build WASM (uses WASI SDK, auto-downloads)
        if: steps.cache-wasm.outputs.cache-hit != 'true'
        working-directory: packages/kql-parser
        run: |
          bunx tree-sitter-cli@latest build --wasm
          echo "âœ“ WASM built successfully"

      - name: Upload WASM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm
          path: packages/kql-parser/tree-sitter-kql.wasm
          if-no-files-found: error

  build-test-publish:
    needs: [build_bindings, build_wasm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.4
          no-cache: true

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-x64-node-modules-${{ hashFiles('bun.lock') }}

      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile

      - name: Download Cross-Platform Bindings
        uses: actions/download-artifact@v4
        with:
          path: packages/kql-parser/prebuilds
          pattern: binding-*
          merge-multiple: false

      - name: Organize Bindings
        run: .github/scripts/organize-bindings.sh

      - name: Download WASM
        uses: actions/download-artifact@v4
        with:
          name: wasm
          path: packages/kql-parser

      - name: Build all packages (turbo)
        run: bun run build

      - name: Run tests (turbo)
        run: bun run test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./packages/*/coverage/lcov.info
          fail_ci_if_error: false
          verbose: true

      - name: Setup .npmrc for GitHub Packages
        run: |
          echo "@fossiq:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Publish affected packages (turbo --affected)
        id: publish
        run: .github/scripts/publish-packages.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger UI deployment
        run: .github/scripts/trigger-ui-deploy.sh
        env:
          DEPLOY_KEY_GITHUB_IO: ${{ secrets.DEPLOY_KEY_GITHUB_IO }}

      - name: Create GitHub Release
        if: steps.publish.outputs.published == '1'
        run: .github/scripts/create-release.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: CI

on:
  push:
    branches:
      - main
    paths:
      - "packages/**"
      - "!packages/**/*.md"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  id-token: write # Required for OIDC
  contents: write
  packages: write # Required for GitHub Packages

jobs:
  # Cross-platform binding build matrix
  build_bindings:
    name: Build Binding ${{ matrix.os }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: ubuntu-24.04-arm
            platform: linux
            arch: arm64
          - os: windows-latest
            platform: win32
            arch: x64
          - os: macos-latest
            platform: darwin
            arch: arm64

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Cache tree-sitter binding
        id: cache-binding
        uses: actions/cache@v4
        with:
          path: packages/kql-parser/prebuilds/${{ matrix.platform }}-${{ matrix.arch }}/tree-sitter-kql.node
          key: binding-${{ matrix.platform }}-${{ matrix.arch }}-${{ hashFiles('packages/kql-parser/src/**/*.c', 'packages/kql-parser/src/**/*.h', 'packages/kql-parser/src/**/*.json', 'packages/kql-parser/binding.gyp') }}

      - name: Build Binding
        if: steps.cache-binding.outputs.cache-hit != 'true'
        working-directory: packages/kql-parser
        run: bun scripts/build-binding.ts

      - name: Upload Binding Artifact
        uses: actions/upload-artifact@v4
        with:
          name: binding-${{ matrix.platform }}-${{ matrix.arch }}
          path: packages/kql-parser/prebuilds/${{ matrix.platform }}-${{ matrix.arch }}/tree-sitter-kql.node
          if-no-files-found: error

  build-test-publish:
    needs: build_bindings
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      # Download all binding artifacts from the build_bindings job
      - name: Download Cross-Platform Bindings
        uses: actions/download-artifact@v4
        with:
          path: packages/kql-parser/prebuilds
          pattern: binding-*
          merge-multiple: false

      - name: Organize Bindings
        run: |
          # actions/download-artifact downloads into folders named after the artifact
          # e.g. packages/kql-parser/prebuilds/binding-linux-x64/tree-sitter-kql.node
          # We want packages/kql-parser/prebuilds/linux-x64/tree-sitter-kql.node
          cd packages/kql-parser/prebuilds
          for dir in binding-*; do
            target="${dir#binding-}"
            mkdir -p "$target"
            mv "$dir"/* "$target/"
            rmdir "$dir"
          done
          echo "Listing organized prebuilds:"
          ls -R

      - name: Setup tree-sitter CLI
        run: bunx tree-sitter-cli@latest --version

      - name: Build WASM (requires Docker/Emscripten in CI environment)
        working-directory: packages/kql-parser
        run: |
          if command -v docker &> /dev/null; then
            bunx tree-sitter build --wasm
            echo "✓ WASM built successfully"
          else
            echo "⚠️  Docker not available, skipping WASM build"
            echo "   Using prebuilt WASM if available"
          fi

      - name: Build all packages
        run: ./.github/scripts/build-packages.sh

      - name: Run tests with coverage
        run: ./.github/scripts/test-packages.sh

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./packages/*/coverage/lcov.info
          fail_ci_if_error: false
          verbose: true

      - name: Setup .npmrc for GitHub Packages
        run: |
          echo "@fossiq:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Publish kql-parser package
        run: bunx npm@latest publish ./packages/kql-parser --ignore-scripts --provenance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish kql-to-duckdb package
        run: bunx npm@latest publish ./packages/kql-to-duckdb --ignore-scripts --provenance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: changesets/action@v1
        with:
          publish: echo "Already published via bun commands above" # We publish manually to control order/flags
          commit: "chore: version packages"
          title: "Release packages"
          createGithubReleases: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
